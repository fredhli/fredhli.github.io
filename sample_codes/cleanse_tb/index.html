
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://fredhli.github.io/sample_codes/cleanse_tb/">
      
      
      
      
      <link rel="icon" href="../../assets/logos/github_file.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.43">
    
    
      
        <title>Sample Code 1 - Fred H. Li</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Open Sans";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#sample-code-1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Fred H. Li" class="md-header__button md-logo" aria-label="Fred H. Li" data-md-component="logo">
      
  <img src="../../assets/logos/github.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Fred H. Li
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Sample Code 1
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/fredhli/fredhli.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    Repository for this Website
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../projects/" class="md-tabs__link">
        
  
    
  
  Projects

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../research_experience/" class="md-tabs__link">
        
  
    
  
  Research Experience

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link">
        
  
    
  
  Sample Codes

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../cv/" class="md-tabs__link">
        
  
    
  
  CV

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../personal/" class="md-tabs__link">
        
  
    
  
  Personal

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Fred H. Li" class="md-nav__button md-logo" aria-label="Fred H. Li" data-md-component="logo">
      
  <img src="../../assets/logos/github.svg" alt="logo">

    </a>
    Fred H. Li
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/fredhli/fredhli.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    Repository for this Website
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../projects/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Projects
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../research_experience/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Research Experience
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sample Codes
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cv/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CV
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../personal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Personal
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<div><h1 id="sample-code-1"><strong>Sample Code 1</strong></h1>
<h2 id="text-based-analysis-of-novel-dataset"><strong>Text-based Analysis of Novel Dataset</strong></h2>
<p>This Python script is a comprehensive text analysis tool designed for processing and analyzing congressional hearing transcripts. It combines multiple natural language processing techniques, including sentiment analysis, OCR error correction, speaker identification, and committee member matching. The script utilizes various libraries such as spaCy, pandas, and the Hugging Face transformers library to handle tasks ranging from basic text preprocessing to advanced entity recognition. Key features include the ability to parse complex document structures, match speakers with committee members, correct OCR errors, and analyze sentiment in congressional discussions.</p>
<h2 id="code"><strong>Code</strong></h2>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">spacy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">basename</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">fuzzywuzzy</span> <span class="kn">import</span> <span class="n">fuzz</span>
<span class="kn">from</span> <span class="nn">fuzzywuzzy</span> <span class="kn">import</span> <span class="n">process</span>

<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">pipeline</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span>
    <span class="s2">"text-classification"</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">"mrm8488/distilroberta-finetuned-financial-news-sentiment-analysis"</span><span class="p">,</span>
    <span class="n">max_length</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
    <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">root</span> <span class="o">=</span> <span class="s2">"C:/Users/lihou/Box/[Redacted]"</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">"data"</span><span class="p">,</span> <span class="s2">"ProQuest"</span><span class="p">,</span> <span class="s2">"processed_metadata"</span><span class="p">)</span>

<span class="c1"># maybe this is a better idea</span>
<span class="n">chairman_ocr_errors</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"The CHAIRMAN"</span><span class="p">,</span>
    <span class="s2">"The CIIAIRMM"</span><span class="p">,</span>
    <span class="s2">"The CHAIRMAx"</span><span class="p">,</span>
    <span class="s2">"The CHAIRMINAN"</span><span class="p">,</span>
    <span class="c1"># Omitted</span>
<span class="p">]</span>

<span class="c1"># -------------------------------------------------------------------------------------------------</span>
<span class="c1"># Functions</span>
<span class="c1"># -------------------------------------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">get_correct_txt_from_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">us_states</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Identifies the text file in a folder that most likely contains a name list by analyzing state references.</span>

<span class="sd">    Args:</span>
<span class="sd">        folder (str): Path to the folder containing text files</span>
<span class="sd">        us_states (list): List of US state names/abbreviations to check for</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Name of the file with highest state-to-line ratio, or None if no files found</span>
<span class="sd">    """</span>
    <span class="n">txt_files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">"*.txt"</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">txt_files</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">result_files</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">txt_file</span> <span class="ow">in</span> <span class="n">txt_files</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt_file</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">content</span> <span class="o">=</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="n">line_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">line_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">state_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">us_states</span><span class="p">)</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">txt_file</span><span class="p">)</span>
            <span class="n">result_files</span><span class="p">[</span><span class="n">file_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_count</span> <span class="o">/</span> <span class="n">line_count</span>

    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">result_files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">result_files</span><span class="o">.</span><span class="n">get</span><span class="p">)</span> <span class="k">if</span> <span class="n">result_files</span> <span class="k">else</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">get_start_indices</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Identifies starting indices for main committee and subcommittees in a text file.</span>

<span class="sd">    Args:</span>
<span class="sd">        txt (str): Path to the text file to analyze</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (main_committee_index, subcommittee_indices_dict)</span>
<span class="sd">            - main_committee_index (int): Line index where main committee starts</span>
<span class="sd">            - subcommittee_indices_dict (dict): Dictionary mapping subcommittee numbers to their starting line indices</span>
<span class="sd">    """</span>
    <span class="n">main_start</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">subcommittee_starts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">subcommittee_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

            <span class="c1"># Skip empty lines</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">words</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Check for main committee</span>
            <span class="k">if</span> <span class="n">main_start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">"COMMITTEE"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">):</span>
                <span class="n">main_start</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">continue</span>

            <span class="c1"># Check for subcommittees (only after main committee is found)</span>
            <span class="k">if</span> <span class="n">main_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">"SUBCOMMITTEE"</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">70</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">):</span>
                <span class="n">subcommittee_starts</span><span class="p">[</span><span class="n">subcommittee_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">subcommittee_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">main_start</span><span class="p">,</span> <span class="n">subcommittee_starts</span>


<span class="k">def</span> <span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">suffix_list</span><span class="p">,</span> <span class="n">us_states</span><span class="p">,</span> <span class="n">identity_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Parse a line containing speaker information in various formats and return a DataFrame.</span>

<span class="sd">    Handles the following formats:</span>
<span class="sd">    1. Normal: 'SPEAKER, State' or 'SPEAKER, Identity'</span>
<span class="sd">    2. Both: 'SPEAKER, State, Identity'</span>
<span class="sd">    3. Line change errors with mixed capitalization</span>
<span class="sd">    4. Suffix variations</span>

<span class="sd">    Args:</span>
<span class="sd">        line (str): Input line to parse</span>
<span class="sd">        suffix_list (list): List of valid suffixes</span>
<span class="sd">        us_states (list): List of US state names/abbreviations</span>
<span class="sd">        identity_list (list): List of known identities</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: DataFrame with columns [Speaker, State, Identity, Suffix, Original Line]</span>
<span class="sd">    """</span>
    <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"Speaker"</span><span class="p">,</span> <span class="s2">"State"</span><span class="p">,</span> <span class="s2">"Identity"</span><span class="p">,</span> <span class="s2">"Suffix"</span><span class="p">,</span> <span class="s2">"Original Line"</span><span class="p">])</span>
    <span class="n">updated_identity_list</span> <span class="o">=</span> <span class="n">identity_list</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Clean and prepare the line</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">n"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
    <span class="n">updated_lines</span> <span class="o">=</span> <span class="n">split_line_on_pattern</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># Process each line after potential splitting</span>
    <span class="k">for</span> <span class="n">updated_line</span> <span class="ow">in</span> <span class="n">updated_lines</span><span class="p">:</span>
        <span class="c1"># Parse parts and handle suffix</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">updated_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">)]</span>
        <span class="n">parts</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">extract_suffix</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">suffix_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_name_length</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Process based on number of parts</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">create_single_part_row</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">create_double_part_row</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">us_states</span><span class="p">,</span> <span class="n">updated_identity_list</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">create_triple_part_row</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">us_states</span><span class="p">,</span> <span class="n">updated_identity_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">row</span><span class="p">])],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dataframe</span>

<span class="k">def</span> <span class="nf">split_line_on_pattern</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Split line on pattern indicating missing newlines."""</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">"([A-Z][a-z]+) ([A-Z][A-Z]+)"</span><span class="p">)</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">", "</span><span class="p">)</span>
    <span class="n">updated_lines</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">new_parts</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\1\n\2"</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">updated_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">new_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updated_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">updated_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">new_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">:])</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updated_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">updated_lines</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">line</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">extract_suffix</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">suffix_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Extract suffix from parts if present."""</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">parts_no_suffix</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">suffix_list</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">part</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parts_no_suffix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parts_no_suffix</span><span class="p">,</span> <span class="n">suffix</span>

<span class="k">def</span> <span class="nf">is_valid_name_length</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Check if name length is valid."""</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="n">parts</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_single_part_row</span><span class="p">(</span><span class="n">speaker</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">original_line</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create row for single part entry."""</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">"Speaker"</span><span class="p">:</span> <span class="n">speaker</span><span class="p">,</span>
        <span class="s2">"State"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">"Identity"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">"Suffix"</span><span class="p">:</span> <span class="n">suffix</span><span class="p">,</span>
        <span class="s2">"Original Line"</span><span class="p">:</span> <span class="n">original_line</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">create_double_part_row</span><span class="p">(</span><span class="n">speaker</span><span class="p">,</span> <span class="n">second_part</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">original_line</span><span class="p">,</span> <span class="n">us_states</span><span class="p">,</span> <span class="n">identity_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create row for double part entry."""</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">extractOne</span><span class="p">(</span><span class="n">second_part</span><span class="p">,</span> <span class="n">us_states</span><span class="p">,</span> <span class="n">score_cutoff</span><span class="o">=</span><span class="mi">65</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">"Speaker"</span><span class="p">:</span> <span class="n">speaker</span><span class="p">,</span>
            <span class="s2">"State"</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">"Identity"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"Suffix"</span><span class="p">:</span> <span class="n">suffix</span><span class="p">,</span>
            <span class="s2">"Original Line"</span><span class="p">:</span> <span class="n">original_line</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">second_part</span> <span class="ow">in</span> <span class="n">identity</span> <span class="k">for</span> <span class="n">identity</span> <span class="ow">in</span> <span class="n">identity_list</span><span class="p">):</span>
            <span class="n">identity_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">second_part</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">"Speaker"</span><span class="p">:</span> <span class="n">speaker</span><span class="p">,</span>
            <span class="s2">"State"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"Identity"</span><span class="p">:</span> <span class="n">second_part</span><span class="p">,</span>
            <span class="s2">"Suffix"</span><span class="p">:</span> <span class="n">suffix</span><span class="p">,</span>
            <span class="s2">"Original Line"</span><span class="p">:</span> <span class="n">original_line</span>
        <span class="p">}</span>

<span class="k">def</span> <span class="nf">create_triple_part_row</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">original_line</span><span class="p">,</span> <span class="n">us_states</span><span class="p">,</span> <span class="n">identity_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create row for triple part entry."""</span>
    <span class="n">speaker</span><span class="p">,</span> <span class="n">part2</span><span class="p">,</span> <span class="n">part3</span> <span class="o">=</span> <span class="n">parts</span>
    <span class="n">state_part2</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">extractOne</span><span class="p">(</span><span class="n">part2</span><span class="p">,</span> <span class="n">us_states</span><span class="p">,</span> <span class="n">score_cutoff</span><span class="o">=</span><span class="mi">65</span><span class="p">)</span>
    <span class="n">state_part3</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">extractOne</span><span class="p">(</span><span class="n">part3</span><span class="p">,</span> <span class="n">us_states</span><span class="p">,</span> <span class="n">score_cutoff</span><span class="o">=</span><span class="mi">65</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">state_part2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">state_part3</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">part3</span> <span class="ow">in</span> <span class="n">identity</span> <span class="k">for</span> <span class="n">identity</span> <span class="ow">in</span> <span class="n">identity_list</span><span class="p">):</span>
            <span class="n">identity_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part3</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">"Speaker"</span><span class="p">:</span> <span class="n">speaker</span><span class="p">,</span>
            <span class="s2">"State"</span><span class="p">:</span> <span class="n">state_part2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">"Identity"</span><span class="p">:</span> <span class="n">part3</span><span class="p">,</span>
            <span class="s2">"Suffix"</span><span class="p">:</span> <span class="n">suffix</span><span class="p">,</span>
            <span class="s2">"Original Line"</span><span class="p">:</span> <span class="n">original_line</span>
        <span class="p">}</span>
    <span class="k">elif</span> <span class="n">state_part3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">state_part2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">part2</span> <span class="ow">in</span> <span class="n">identity</span> <span class="k">for</span> <span class="n">identity</span> <span class="ow">in</span> <span class="n">identity_list</span><span class="p">):</span>
            <span class="n">identity_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">"Speaker"</span><span class="p">:</span> <span class="n">speaker</span><span class="p">,</span>
            <span class="s2">"State"</span><span class="p">:</span> <span class="n">state_part3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">"Identity"</span><span class="p">:</span> <span class="n">part2</span><span class="p">,</span>
            <span class="s2">"Suffix"</span><span class="p">:</span> <span class="n">suffix</span><span class="p">,</span>
            <span class="s2">"Original Line"</span><span class="p">:</span> <span class="n">original_line</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">generate_ranges</span><span class="p">(</span><span class="n">main_index</span><span class="p">,</span> <span class="n">sub_indices</span><span class="p">,</span> <span class="n">total_lines</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This function serves to generate line indices based on the main_index and sub_indices.</span>
<span class="sd">    """</span>
    <span class="n">subs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">main_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Filter sub_indices to remove main_index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sub_indices</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">sub_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">main_index</span><span class="p">:</span>
                <span class="n">subs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_indices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">main_index</span><span class="p">,</span> <span class="n">total_lines</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="c1"># return (main_index, subs[0]), (subs[0], subs[1]), ..., (subs[-1], total_lines)</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="p">[(</span><span class="n">main_index</span><span class="p">,</span> <span class="n">subs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">subs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">subs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">total_lines</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ranges</span>


<span class="k">def</span> <span class="nf">extract_committee</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">suffix_list</span><span class="p">,</span> <span class="n">us_states</span><span class="p">,</span> <span class="n">identity_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Extract potential speakers from committee and subcommittee sections in a text file.</span>

<span class="sd">    Args:</span>
<span class="sd">        txt (str): Path to the text file to analyze.</span>
<span class="sd">        suffix_list (list): List of valid suffixes.</span>
<span class="sd">        us_states (list): List of US state names/abbreviations.</span>
<span class="sd">        identity_list (list): List of known identities.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: DataFrame containing speaker information.</span>
<span class="sd">    """</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\d</span><span class="si">{4}</span><span class="s2">"</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">"Speaker"</span><span class="p">,</span> <span class="s2">"State"</span><span class="p">,</span> <span class="s2">"Identity"</span><span class="p">,</span> <span class="s2">"Suffix"</span><span class="p">,</span> <span class="s2">"Original Line"</span><span class="p">,</span>
            <span class="s2">"Committee"</span><span class="p">,</span> <span class="s2">"File Name"</span><span class="p">,</span> <span class="s2">"Year"</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">main_index</span><span class="p">,</span> <span class="n">sub_indices</span> <span class="o">=</span> <span class="n">get_start_indices</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">total_lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="n">generate_ranges</span><span class="p">(</span><span class="n">main_index</span><span class="p">,</span> <span class="n">sub_indices</span><span class="p">,</span> <span class="n">total_lines</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ranges</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dataframe</span>

        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span>
            <span class="n">committee</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">start</span><span class="p">:</span>
                    <span class="n">committee</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df_to_concat</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">suffix_list</span><span class="p">,</span> <span class="n">us_states</span><span class="p">,</span> <span class="n">identity_list</span><span class="p">)</span>
                    <span class="n">df_to_concat</span><span class="p">[</span><span class="s2">"Committee"</span><span class="p">]</span> <span class="o">=</span> <span class="n">committee</span>
                    <span class="n">df_to_concat</span><span class="p">[</span><span class="s2">"File Name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_name</span>
                    <span class="n">df_to_concat</span><span class="p">[</span><span class="s2">"Year"</span><span class="p">]</span> <span class="o">=</span> <span class="n">year</span>
                    <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">df_to_concat</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dataframe</span>



<span class="k">def</span> <span class="nf">correct_identity</span><span class="p">(</span><span class="n">identity</span><span class="p">,</span> <span class="n">acceptable_identity_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Corrects the identity of a speaker based on an acceptable identity list.</span>

<span class="sd">    Args:</span>
<span class="sd">        identity (str): The identity to be corrected.</span>
<span class="sd">        acceptable_identity_list (list): List of acceptable identities.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Corrected identity or 'no_identity'/'no_match' if not found.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">identity</span> <span class="ow">or</span> <span class="n">identity</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">"."</span><span class="p">,</span> <span class="s2">""</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s2">"no_identity"</span>

    <span class="n">identity</span> <span class="o">=</span> <span class="n">identity</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">extractOne</span><span class="p">(</span><span class="n">identity</span><span class="p">,</span> <span class="n">acceptable_identity_list</span><span class="p">,</span> <span class="n">score_cutoff</span><span class="o">=</span><span class="mi">70</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="s2">"no_match"</span>



<span class="k">def</span> <span class="nf">estimate_individual_probability</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">,</span> <span class="n">nlp</span><span class="p">):</span>
    <span class="n">templates</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">"During the hearing, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> provided expert testimony on the matter."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">, a recognized authority in the field, was cited frequently during the discussions."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"The statement by </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> was referenced multiple times by committee members."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"Senator Johnson addressed </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> directly during the questioning session."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"As noted in the proceedings, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has been a key figure in this investigation."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">'s written testimony, submitted prior to the session, outlined several key points."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"The amendment proposed by </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> was considered during the debate."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"Congresswoman Smith thanked </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> for their detailed report on the issue."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"The chairperson asked </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> to clarify their previous statements."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"According to </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">, the data presented during the hearing was conclusive."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"In his closing remarks, the attorney general mentioned </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">'s contributions to the case."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"The recent policy paper by </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> was mentioned as a significant piece of evidence."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"During the panel discussion, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> argued for stricter regulations."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"The insights from </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> were pivotal to the committee's understanding of the issue."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"After the session, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> was interviewed by several media outlets regarding their stance."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> was among the experts invited to discuss the implications of the new legislation."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"The findings from </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">'s research were heavily debated during the hearing."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"In an unexpected move, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> challenged the committee's previous conclusions."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> was acknowledged by the chair for their extensive work on the subject."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"Following the recommendations by </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">, the committee decided to revise their initial position."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">'s previous work on the subject was highly regarded by the committee members."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"During the testimony, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> cited several recent studies to support their argument."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"The historical context provided by </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> was essential for understanding the debate."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"Representative Davis highlighted </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">'s contributions to the field during her speech."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">, a long-standing member of the board, offered a dissenting opinion."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"The policy brief authored by </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> was circulated among the attendees."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"In his memo, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> outlined the potential impacts of the proposed changes."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> was called upon to further elaborate on their previous remarks."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"The committee praised </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> for their meticulous research and presentation skills."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> responded to the queries regarding the accuracy of the data presented."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"Several participants expressed their support for the initiatives suggested by </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"The legal perspectives shared by </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> were crucial to the discussions."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"In their written submission, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> addressed several critical issues."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">'s role as a mediator was commended by all parties involved."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"The detailed analysis by </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> helped shape the committee's final decision."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"During the recess, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> discussed the implications of the hearing with the press."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"The theoretical framework developed by </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> was a focal point of the session."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">'s credentials were verified by the committee before the hearing."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"The cross-examination by </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> brought new facts to light."</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> was responsible for compiling the comprehensive report on the issue."</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Count the occurrences where the name is recognized as the specified entity type</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">:</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">ents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ent</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">ent</span><span class="o">.</span><span class="n">label_</span> <span class="o">==</span> <span class="n">entity_type</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Return the probability of the name being recognized as the specified entity type</span>
    <span class="k">return</span> <span class="n">count</span> <span class="o">/</span> <span class="n">total</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">match_committee_with_pol</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">congress</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This function serves to match the committee names with an existing house and senate database to correct any misspellings.</span>
<span class="sd">    """</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">"committee_member"</span><span class="p">])</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">"year"</span><span class="p">])</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"state_po"</span><span class="p">]</span>
    <span class="c1"># to prevent any errors in North/South,East/West</span>
    <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">"NC"</span> <span class="ow">or</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">"SC"</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="s2">"CAR"</span>
    <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">"ND"</span> <span class="ow">or</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">"SD"</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="s2">"DAK"</span>
    <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">"VA"</span> <span class="ow">or</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">"WV"</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="s2">"VIR"</span>
    <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">"WA"</span> <span class="ow">or</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">"DC"</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="s2">"WAS"</span>

    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">""</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">"."</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">"nan"</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_party"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_score"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"without_state_and_match"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="c1"># For a house member, range: (year - 2, year); for a senate member, range: (year - 6, year)</span>
    <span class="n">house_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">year</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">senate_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">year</span> <span class="o">-</span> <span class="mi">6</span><span class="p">,</span> <span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">house_criteria</span> <span class="o">=</span> <span class="p">(</span><span class="n">congress</span><span class="p">[</span><span class="s2">"office"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"house"</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="n">congress</span><span class="p">[</span><span class="s2">"year"</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">house_range</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">senate_criteria</span> <span class="o">=</span> <span class="p">(</span><span class="n">congress</span><span class="p">[</span><span class="s2">"office"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"senate"</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="n">congress</span><span class="p">[</span><span class="s2">"year"</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">senate_range</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">congress_possible</span> <span class="o">=</span> <span class="n">congress</span><span class="p">[</span><span class="n">house_criteria</span> <span class="o">|</span> <span class="n">senate_criteria</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">congress_possible</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"No matches in </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_party"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_score"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="c1"># STEP 1: MATCH FULL NAME</span>
    <span class="c1"># Match the name with the congress_possible</span>
    <span class="n">possible_names</span> <span class="o">=</span> <span class="n">congress_possible</span><span class="p">[</span><span class="s2">"candidate"</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">possible_names</span><span class="p">)</span>
    <span class="c1"># Only keep results with score &gt; 80</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">]</span>
    <span class="n">congress_match_fullname</span> <span class="o">=</span> <span class="n">congress_possible</span><span class="p">[</span>
        <span class="n">congress_possible</span><span class="p">[</span><span class="s2">"candidate"</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">congress_match_fullname</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_fullname</span><span class="p">[</span><span class="s2">"candidate"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_party"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_fullname</span><span class="p">[</span><span class="s2">"party"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_fullname</span><span class="p">[</span><span class="s2">"office"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_fullname</span><span class="p">[</span><span class="s2">"year"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"full_name"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_score"</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_fullname</span><span class="p">[</span><span class="s2">"state_po_original"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"without_state_and_match"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Check the state</span>
        <span class="n">congress_match_fullname</span> <span class="o">=</span> <span class="n">congress_match_fullname</span><span class="p">[</span>
            <span class="n">congress_match_fullname</span><span class="p">[</span><span class="s2">"state_po"</span><span class="p">]</span> <span class="o">==</span> <span class="n">state</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">congress_match_fullname</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_fullname</span><span class="p">[</span><span class="s2">"candidate"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_party"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_fullname</span><span class="p">[</span><span class="s2">"party"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_fullname</span><span class="p">[</span><span class="s2">"office"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_fullname</span><span class="p">[</span><span class="s2">"year"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"full_name"</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_score"</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_fullname</span><span class="p">[</span><span class="s2">"state_po_original"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span>
                <span class="mi">0</span>
            <span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"without_state_and_match"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">row</span>

        <span class="c1"># STEP 2 &amp; 3: MATCH LAST NAME AND FIRST NAME IF POSSIBLE. IF NOT, ONLY MATCH LAST NAME</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"last_name"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">last_name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">last_name</span> <span class="o">==</span> <span class="s2">""</span> <span class="ow">or</span> <span class="n">last_name</span> <span class="o">==</span> <span class="s2">"."</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"No matches: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">"matched_party"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">"matched_score"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">"without_state_and_match"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">return</span> <span class="n">row</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">first_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"committee_member"</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">last_name</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">first_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"committee_member"</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">first_name</span> <span class="o">=</span> <span class="s2">""</span>

            <span class="c1"># Ensure 'last_name' is a list</span>
            <span class="n">possible_last_names</span> <span class="o">=</span> <span class="n">congress_possible</span><span class="p">[</span><span class="s2">"last_name"</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">last_name_results</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">last_name</span><span class="p">,</span> <span class="n">possible_last_names</span><span class="p">)</span>
            <span class="c1"># Only keep results with score &gt; 80</span>
            <span class="n">last_name_results</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">result</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">last_name_results</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">80</span>
            <span class="p">]</span>
            <span class="n">congress_match_lastname</span> <span class="o">=</span> <span class="n">congress_possible</span><span class="p">[</span>
                <span class="n">congress_possible</span><span class="p">[</span><span class="s2">"last_name"</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">last_name_results</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="n">congress_match_lastname</span><span class="p">[</span><span class="s2">"first_name"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">""</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">row_lastname</span> <span class="ow">in</span> <span class="n">congress_match_lastname</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">congress_match_lastname</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="s2">"first_name"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">row_lastname</span><span class="p">[</span><span class="s2">"candidate"</span><span class="p">]</span>
                        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">row_lastname</span><span class="p">[</span><span class="s2">"last_name"</span><span class="p">],</span> <span class="s2">""</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">congress_match_lastname</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="s2">"first_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_lastname</span><span class="p">[</span>
                            <span class="s2">"candidate"</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>

            <span class="n">congress_match_firstnamelist</span> <span class="o">=</span> <span class="n">congress_match_lastname</span><span class="p">[</span>
                <span class="s2">"first_name"</span>
            <span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">first_name_results</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">process</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">congress_match_firstnamelist</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">first_name</span> <span class="o">!=</span> <span class="s2">""</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">first_name_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">first_name_results</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">result</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">first_name_results</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">40</span>
                <span class="p">]</span>
                <span class="n">congress_match_lastandfirst</span> <span class="o">=</span> <span class="n">congress_match_lastname</span><span class="p">[</span>
                    <span class="n">congress_match_lastname</span><span class="p">[</span><span class="s2">"first_name"</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">first_name_results</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">first_name_results</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="n">congress_match_firstnamelist</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">congress_match_firstnamelist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="c1"># STEP 3: ONLY MATCH LAST NAME, MOST INACCRURATE</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">congress_match_lastname</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastname</span><span class="p">[</span>
                            <span class="s2">"candidate"</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_party"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastname</span><span class="p">[</span><span class="s2">"party"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span>
                            <span class="mi">0</span>
                        <span class="p">]</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastname</span><span class="p">[</span>
                            <span class="s2">"office"</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastname</span><span class="p">[</span><span class="s2">"year"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"last_name_only"</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_score"</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_name_results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastname</span><span class="p">[</span>
                            <span class="s2">"state_po_original"</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">"without_state_and_match"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">congress_match_lastname</span> <span class="o">=</span> <span class="n">congress_match_lastname</span><span class="p">[</span>
                            <span class="n">congress_match_lastname</span><span class="p">[</span><span class="s2">"state_po"</span><span class="p">]</span> <span class="o">==</span> <span class="n">state</span>
                        <span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">congress_match_lastname</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastname</span><span class="p">[</span>
                                <span class="s2">"candidate"</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_party"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastname</span><span class="p">[</span>
                                <span class="s2">"party"</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastname</span><span class="p">[</span>
                                <span class="s2">"office"</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastname</span><span class="p">[</span>
                                <span class="s2">"year"</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"last_name_only"</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_score"</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_name_results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastname</span><span class="p">[</span>
                                <span class="s2">"state_po_original"</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"without_state_and_match"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"No match: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_party"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_score"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"without_state_and_match"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">"matched_party"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">"matched_score"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">"without_state_and_match"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># STEP 2: MATCH LAST NAME AND THEN FIRST NAME, FIRST NAME SCORE &gt; 40</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">congress_match_lastandfirst</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastandfirst</span><span class="p">[</span>
                            <span class="s2">"candidate"</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_party"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastandfirst</span><span class="p">[</span>
                            <span class="s2">"party"</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastandfirst</span><span class="p">[</span>
                            <span class="s2">"office"</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastandfirst</span><span class="p">[</span>
                            <span class="s2">"year"</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"last_and_first"</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_score"</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_name_results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastandfirst</span><span class="p">[</span>
                            <span class="s2">"state_po_original"</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">"without_state_and_match"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">congress_match_lastandfirst</span> <span class="o">=</span> <span class="n">congress_match_lastandfirst</span><span class="p">[</span>
                            <span class="n">congress_match_lastandfirst</span><span class="p">[</span><span class="s2">"state_po"</span><span class="p">]</span> <span class="o">==</span> <span class="n">state</span>
                        <span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">congress_match_lastandfirst</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastandfirst</span><span class="p">[</span>
                                <span class="s2">"candidate"</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_party"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastandfirst</span><span class="p">[</span>
                                <span class="s2">"party"</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastandfirst</span><span class="p">[</span>
                                <span class="s2">"office"</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastandfirst</span><span class="p">[</span>
                                <span class="s2">"year"</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"last_and_first"</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_score"</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_name_results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="n">congress_match_lastandfirst</span><span class="p">[</span>
                                <span class="s2">"state_po_original"</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"without_state_and_match"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"No match: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_party"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_score"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">"without_state_and_match"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">row</span>


<span class="k">def</span> <span class="nf">preprocess_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This function serves to preprocess the dataframe for matching with the committee members.</span>
<span class="sd">    """</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">"file"</span><span class="p">]</span> <span class="o">==</span> <span class="n">file_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">"speaker_original"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">"section"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"section"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">prefix_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">"mr"</span><span class="p">,</span>
        <span class="s2">"mrs"</span><span class="p">,</span>
        <span class="s2">"ms"</span><span class="p">,</span>
        <span class="s2">"miss"</span><span class="p">,</span>
        <span class="s2">"dr"</span><span class="p">,</span>
        <span class="s2">"prof"</span><span class="p">,</span>
        <span class="s2">"representative"</span><span class="p">,</span>
        <span class="s2">"senator"</span><span class="p">,</span>
        <span class="s2">"chairman"</span><span class="p">,</span>
        <span class="s2">"chairwoman"</span><span class="p">,</span>
        <span class="s2">"vice"</span><span class="p">,</span>
        <span class="s2">"chair"</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Create a regex pattern for prefixes, including case insensitivity and optional period</span>
    <span class="n">prefix_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"(?i)^\b("</span> <span class="o">+</span> <span class="s2">"|"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix_list</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">")[\.\s]*"</span>

    <span class="c1"># Replace prefixes in a case-insensitive manner</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">prefix_pattern</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\."</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">ensure_columns_exist</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This function serves to ensure that the columns exist in the dataframe.</span>
<span class="sd">    """</span>

    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">extract_chair_lastnames</span><span class="p">(</span><span class="n">speakers</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This function serves to extract the chair lastnames from the speakers list.</span>
<span class="sd">    """</span>
    <span class="n">chair_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">speakers</span> <span class="k">if</span> <span class="s2">"chair"</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
    <span class="n">chair_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">chair_list</span> <span class="k">if</span> <span class="s2">"the"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
    <span class="n">chair_lastname_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">chair_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">chair_list</span><span class="p">:</span>
            <span class="n">words</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">words</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">"chair"</span> <span class="ow">in</span> <span class="n">word</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">):</span>
                    <span class="n">chair_lastname_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chair_lastname_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">chair_list</span><span class="p">,</span> <span class="n">chair_lastname_list</span>


<span class="k">def</span> <span class="nf">match_chair</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">dfc</span><span class="p">,</span> <span class="n">chair_list</span><span class="p">,</span> <span class="n">chair_lastname_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This function serves to match the chair with the committee members.</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">chair_lastname_list</span><span class="p">:</span>
        <span class="n">dfc_temp</span> <span class="o">=</span> <span class="n">dfc</span><span class="p">[</span><span class="n">dfc</span><span class="p">[</span><span class="s2">"identity"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"chair"</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
        <span class="n">dfc_temp</span> <span class="o">=</span> <span class="n">dfc_temp</span><span class="p">[</span><span class="o">~</span><span class="n">dfc_temp</span><span class="p">[</span><span class="s2">"identity"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"vice"</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfc_temp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">dfh</span><span class="p">[</span>
                <span class="p">(</span><span class="n">dfh</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"chair"</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">dfh</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"vice"</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="n">dfh</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="s2">"matched"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfc_temp</span><span class="p">)</span>
            <span class="n">dfh</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfc_temp</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
                <span class="n">sep</span><span class="o">=</span><span class="s2">" &amp; "</span>
            <span class="p">)</span>
            <span class="n">dfh</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">indices</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="s2">"matched_year"</span><span class="p">,</span>
                    <span class="s2">"matched_state"</span><span class="p">,</span>
                    <span class="s2">"matched_identity"</span><span class="p">,</span>
                    <span class="s2">"matched_office"</span><span class="p">,</span>
                    <span class="s2">"matched_method"</span><span class="p">,</span>
                    <span class="s2">"matched_committee"</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">dfc_temp</span><span class="p">[</span>
                <span class="p">[</span>
                    <span class="s2">"matched_year"</span><span class="p">,</span>
                    <span class="s2">"matched_state"</span><span class="p">,</span>
                    <span class="s2">"matched_identity"</span><span class="p">,</span>
                    <span class="s2">"matched_office"</span><span class="p">,</span>
                    <span class="s2">"matched_method"</span><span class="p">,</span>
                    <span class="s2">"matched_committee"</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s2">" &amp; "</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfc_temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">dfh</span><span class="p">[(</span><span class="n">dfh</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"chair"</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">))]</span><span class="o">.</span><span class="n">index</span>
            <span class="n">dfh</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="s2">"matched"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">"matched_name"</span><span class="p">,</span>
                <span class="s2">"matched_year"</span><span class="p">,</span>
                <span class="s2">"matched_state"</span><span class="p">,</span>
                <span class="s2">"matched_identity"</span><span class="p">,</span>
                <span class="s2">"matched_office"</span><span class="p">,</span>
                <span class="s2">"matched_method"</span><span class="p">,</span>
                <span class="s2">"matched_committee"</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="n">dfh</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfc_temp</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">match_lastnames</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">dfc</span><span class="p">,</span> <span class="n">chair_lastname_list</span><span class="p">,</span> <span class="s2">"chair"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">extract_vice_chair_lastnames</span><span class="p">(</span><span class="n">speakers</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This function serves to extract the vice chair lastnames from the speakers list.</span>
<span class="sd">    """</span>

    <span class="n">vice_chair_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">speakers</span> <span class="k">if</span> <span class="s2">"vice"</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
    <span class="n">vice_chair_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">vice_chair_list</span> <span class="k">if</span> <span class="s2">"the"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
    <span class="n">vice_chair_lastname_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">vice_chair_list</span><span class="p">:</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">words</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">"vice"</span> <span class="ow">in</span> <span class="n">word</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">):</span>
                <span class="n">vice_chair_lastname_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">vice_chair_list</span><span class="p">,</span> <span class="n">vice_chair_lastname_list</span>


<span class="k">def</span> <span class="nf">match_vice_chair</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">dfc</span><span class="p">,</span> <span class="n">vice_chair_list</span><span class="p">,</span> <span class="n">vice_chair_lastname_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This function serves to match the vice chair with the committee members.</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">vice_chair_lastname_list</span><span class="p">:</span>
        <span class="n">dfc_temp</span> <span class="o">=</span> <span class="n">dfc</span><span class="p">[</span><span class="n">dfc</span><span class="p">[</span><span class="s2">"identity"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">"vice"</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
        <span class="n">update_dataframe</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">dfc_temp</span><span class="p">,</span> <span class="n">vice_chair_list</span><span class="p">,</span> <span class="s2">"vice-chair"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">match_lastnames</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">dfc</span><span class="p">,</span> <span class="n">vice_chair_lastname_list</span><span class="p">,</span> <span class="s2">"vice-chair"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">update_dataframe</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">dfc_temp</span><span class="p">,</span> <span class="n">speaker_list</span><span class="p">,</span> <span class="n">role</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfc_temp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">update_multiple_matches</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">dfc_temp</span><span class="p">,</span> <span class="n">speaker_list</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfc_temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">update_single_match</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">dfc_temp</span><span class="p">,</span> <span class="n">speaker_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">update_no_match</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">speaker_list</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">update_multiple_matches</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">dfc_temp</span><span class="p">,</span> <span class="n">speaker_list</span><span class="p">):</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">dfh</span><span class="p">[</span><span class="n">dfh</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">speaker_list</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>
    <span class="n">dfh</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="s2">"matched"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfc_temp</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">"matched_name"</span><span class="p">,</span>
        <span class="s2">"matched_year"</span><span class="p">,</span>
        <span class="s2">"matched_state"</span><span class="p">,</span>
        <span class="s2">"matched_identity"</span><span class="p">,</span>
        <span class="s2">"matched_office"</span><span class="p">,</span>
        <span class="s2">"matched_method"</span><span class="p">,</span>
        <span class="s2">"matched_committee"</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">dfh</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfc_temp</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s2">" &amp; "</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">update_single_match</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">dfc_temp</span><span class="p">,</span> <span class="n">speaker_list</span><span class="p">):</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">dfh</span><span class="p">[</span><span class="n">dfh</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">speaker_list</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>
    <span class="n">dfh</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="s2">"matched"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">"matched_name"</span><span class="p">,</span>
        <span class="s2">"matched_year"</span><span class="p">,</span>
        <span class="s2">"matched_state"</span><span class="p">,</span>
        <span class="s2">"matched_identity"</span><span class="p">,</span>
        <span class="s2">"matched_office"</span><span class="p">,</span>
        <span class="s2">"matched_method"</span><span class="p">,</span>
        <span class="s2">"matched_committee"</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">dfh</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfc_temp</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">update_no_match</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">speaker_list</span><span class="p">):</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">dfh</span><span class="p">[</span><span class="n">dfh</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">speaker_list</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>
    <span class="n">dfh</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="s2">"matched"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dfh</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="n">indices</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="s2">"matched_name"</span><span class="p">,</span>
            <span class="s2">"matched_year"</span><span class="p">,</span>
            <span class="s2">"matched_state"</span><span class="p">,</span>
            <span class="s2">"matched_office"</span><span class="p">,</span>
            <span class="s2">"matched_method"</span><span class="p">,</span>
            <span class="s2">"matched_committee"</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
    <span class="n">dfh</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="s2">"matched_identity"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_identity"</span>


<span class="k">def</span> <span class="nf">match_lastnames</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">dfc</span><span class="p">,</span> <span class="n">lastname_list</span><span class="p">,</span> <span class="n">role</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This function serves to match the lastnames with the committee members.</span>
<span class="sd">    """</span>

    <span class="n">dfc</span><span class="p">[</span><span class="s2">"last_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfc</span><span class="p">[</span><span class="s2">"last_name"</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
    <span class="n">dfc</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfc</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">lastname_list</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">extractOne</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">dfc</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">:</span>
            <span class="n">matched_row</span> <span class="o">=</span> <span class="n">dfc</span><span class="p">[</span><span class="n">dfc</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">update_single_match</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">matched_row</span><span class="p">,</span> <span class="p">[</span><span class="n">entry</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">update_no_match</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="p">[</span><span class="n">entry</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">match_remaining_speakers</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">dfc</span><span class="p">,</span> <span class="n">speakers</span><span class="p">,</span> <span class="n">prefix_list</span><span class="p">):</span>
    <span class="n">dfc</span><span class="p">[</span><span class="s2">"last_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfc</span><span class="p">[</span><span class="s2">"last_name"</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
    <span class="n">dfc</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfc</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
    <span class="n">speaker_lastname_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">speakers</span> <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">prefix_list</span>
    <span class="p">]</span>
    <span class="n">potential_speakers</span> <span class="o">=</span> <span class="n">dfc</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">potential_speakers_lastname</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">potential_speakers</span> <span class="k">if</span> <span class="n">s</span>
    <span class="p">]</span>  <span class="c1"># Ensure non-empty strings</span>

    <span class="k">for</span> <span class="n">last_name</span> <span class="ow">in</span> <span class="n">speaker_lastname_list</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">extractOne</span><span class="p">(</span><span class="n">last_name</span><span class="p">,</span> <span class="n">potential_speakers_lastname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">:</span>
            <span class="n">matched_row</span> <span class="o">=</span> <span class="n">dfc</span><span class="p">[</span><span class="n">dfc</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">update_single_match</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">matched_row</span><span class="p">,</span> <span class="p">[</span><span class="n">last_name</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_row</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">update_multiple_matches</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">matched_row</span><span class="p">,</span> <span class="p">[</span><span class="n">last_name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">update_no_match</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="p">[</span><span class="n">last_name</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">update_no_match</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="p">[</span><span class="n">last_name</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">match_hearing_with_committee_member</span><span class="p">(</span><span class="n">tomatch</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This is the main function to match the hearing with the committee members.</span>
<span class="sd">    """</span>

    <span class="n">dfh</span> <span class="o">=</span> <span class="n">preprocess_dataframe</span><span class="p">(</span><span class="n">tomatch</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
    <span class="n">dfc</span> <span class="o">=</span> <span class="n">matched</span><span class="p">[</span><span class="n">matched</span><span class="p">[</span><span class="s2">"file_name"</span><span class="p">]</span> <span class="o">==</span> <span class="n">file_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">ensure_columns_exist</span><span class="p">(</span>
        <span class="n">dfh</span><span class="p">,</span>
        <span class="p">[</span>
            <span class="s2">"matched"</span><span class="p">,</span>
            <span class="s2">"matched_name"</span><span class="p">,</span>
            <span class="s2">"matched_year"</span><span class="p">,</span>
            <span class="s2">"matched_state"</span><span class="p">,</span>
            <span class="s2">"matched_identity"</span><span class="p">,</span>
            <span class="s2">"matched_office"</span><span class="p">,</span>
            <span class="s2">"matched_method"</span><span class="p">,</span>
            <span class="s2">"matched_committee"</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">)</span>

    <span class="n">speakers</span> <span class="o">=</span> <span class="n">dfh</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">chair_list</span><span class="p">,</span> <span class="n">chair_lastname_list</span> <span class="o">=</span> <span class="n">extract_chair_lastnames</span><span class="p">(</span><span class="n">speakers</span><span class="p">)</span>
    <span class="n">match_chair</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">dfc</span><span class="p">,</span> <span class="n">chair_list</span><span class="p">,</span> <span class="n">chair_lastname_list</span><span class="p">)</span>

    <span class="n">vice_chair_list</span><span class="p">,</span> <span class="n">vice_chair_lastname_list</span> <span class="o">=</span> <span class="n">extract_vice_chair_lastnames</span><span class="p">(</span><span class="n">speakers</span><span class="p">)</span>
    <span class="n">match_vice_chair</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">dfc</span><span class="p">,</span> <span class="n">vice_chair_list</span><span class="p">,</span> <span class="n">vice_chair_lastname_list</span><span class="p">)</span>

    <span class="n">remaining_speakers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">speakers</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chair_list</span> <span class="ow">and</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vice_chair_list</span>
    <span class="p">]</span>
    <span class="n">remaining_speakers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">remaining_speakers</span> <span class="k">if</span> <span class="s2">"chair"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span> <span class="ow">and</span> <span class="s2">"vice"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span>
    <span class="p">]</span>
    <span class="n">prefix_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"mr"</span><span class="p">,</span> <span class="s2">"mrs"</span><span class="p">,</span> <span class="s2">"ms"</span><span class="p">,</span> <span class="s2">"miss"</span><span class="p">,</span> <span class="s2">"dr"</span><span class="p">,</span> <span class="s2">"prof"</span><span class="p">,</span> <span class="s2">"representative"</span><span class="p">,</span> <span class="s2">"senator"</span><span class="p">]</span>
    <span class="n">match_remaining_speakers</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">dfc</span><span class="p">,</span> <span class="n">remaining_speakers</span><span class="p">,</span> <span class="n">prefix_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dfh</span>


<span class="k">def</span> <span class="nf">hearing_sentiment</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pipe_model</span><span class="o">=</span><span class="n">pipe</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This function serves to estimate sentiment to the hearing text.</span>
<span class="sd">    """</span>

    <span class="n">sentiments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sentiment_scores</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="n">text_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">][</span><span class="s2">"text"</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">pipe_model</span><span class="p">(</span><span class="n">text_list</span><span class="p">)</span>

        <span class="n">sentiments</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">result</span><span class="p">[</span><span class="s2">"label"</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
        <span class="n">sentiment_scores</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">result</span><span class="p">[</span><span class="s2">"score"</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>

    <span class="c1"># Assign the results back to the dataframe</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">"sentiment"</span><span class="p">]</span> <span class="o">=</span> <span class="n">sentiments</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">"sentiment_score"</span><span class="p">]</span> <span class="o">=</span> <span class="n">sentiment_scores</span>

    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">find_possible_ocr_typo</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">90</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">substring</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">substring</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">substring</span><span class="p">,</span> <span class="n">score</span><span class="p">))</span>

    <span class="n">matches</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">matches</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_mostly_uppercase</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">uppercase_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isupper</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">uppercase_count</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">filtered_matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span> <span class="k">if</span> <span class="n">is_mostly_uppercase</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

    <span class="k">return</span> <span class="n">filtered_matches</span>


<span class="k">def</span> <span class="nf">update_ocr_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">90</span><span class="p">):</span>
    <span class="n">df_temp</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">"file"</span><span class="p">]</span> <span class="o">==</span> <span class="n">file</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">target_list</span> <span class="o">=</span> <span class="n">df_temp</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_temp</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">target_list</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">find_possible_ocr_typo</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">df_temp</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">"ocr_corrections"</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>

    <span class="k">return</span> <span class="n">df_temp</span>


<span class="k">def</span> <span class="nf">parse_text</span><span class="p">(</span><span class="n">text_original</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Step 1: Deal with Prefix Errors</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text_original</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"  "</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span>

    <span class="n">speaker_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">"(mr\.|mrs\.|ms\.|miss|senator|representative|chairman|vice|dr\.)\s([^\s]+)"</span>
    <span class="p">)</span>
    <span class="c1"># how to be more accurate in prefixes?</span>
    <span class="n">speaker_matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">speaker_regex</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="c1"># print(speaker_matches)</span>

    <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">speaker_matches</span><span class="p">:</span>
        <span class="n">full_candidate</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2">"</span>
        <span class="c1"># only consider about capital situation of candidate not prefix regarding "Senator XXXX" situation</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">candidate</span><span class="p">),</span> <span class="n">text_original</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
            <span class="n">original_candidate</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">upper_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">original_candidate</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isupper</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">upper_count</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_candidate</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="ow">and</span> <span class="n">upper_count</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">original_idx</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">results</span><span class="p">[</span><span class="n">full_candidate</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_idx</span>

    <span class="c1"># Step 2: Extract Capitalized Words and compare with "CHAIRMAN"</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">text_original</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">valid_words</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">upper_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">word</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isupper</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">upper_count</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">:</span>
                <span class="n">valid_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">valid_words</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">"VICE"</span> <span class="ow">in</span> <span class="n">word</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s2">"vice-chair_</span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">text_original</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="n">valid_words</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="s2">"CHAIR"</span> <span class="ow">in</span> <span class="n">word</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s2">"chair_</span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">text_original</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="n">valid_words</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="c1"># Irregular words</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">valid_words</span><span class="p">:</span>
        <span class="n">scores_chair</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">"CHAIRMAN"</span><span class="p">),</span>
            <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">"CHAIRWOMAN"</span><span class="p">),</span>
            <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">"CHAIR"</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">score</span> <span class="o">&gt;</span> <span class="mi">70</span> <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">scores_chair</span><span class="p">):</span>
            <span class="n">original_idx</span> <span class="o">=</span> <span class="n">text_original</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">"chair"</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_idx</span>

        <span class="n">scores_vicechair</span> <span class="o">=</span> <span class="p">[</span><span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">"VICECHAIR"</span><span class="p">),</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">"VICE"</span><span class="p">)]</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">score</span> <span class="o">&gt;</span> <span class="mi">70</span> <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">scores_vicechair</span><span class="p">):</span>
            <span class="n">original_idx</span> <span class="o">=</span> <span class="n">text_original</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">"vice-chair"</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_idx</span>

    <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># Step 3: Remove Duplicates (to specify, when two keys share a same value, remove the shorter one)</span>
    <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">to_remove</span><span class="p">):</span>
        <span class="n">results</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>


<span class="k">def</span> <span class="nf">line_change</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">text_original</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"note"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_error"</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="n">new_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">text_split</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_original</span><span class="p">)</span>

    <span class="n">split_points</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">split_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">split_points</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">split_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">length</span><span class="p">:</span>
        <span class="n">split_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">split_points</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="n">split_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="n">split_points</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">segment</span> <span class="o">=</span> <span class="n">text_original</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">start_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">speaker</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">speaker</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">start_idx</span><span class="p">)</span>

        <span class="n">text_split</span><span class="p">[</span><span class="n">start_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"text"</span><span class="p">:</span> <span class="n">segment</span><span class="p">,</span> <span class="s2">"speaker"</span><span class="p">:</span> <span class="n">speaker</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">text_split</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">row_original</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">row_original</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span>
            <span class="n">row_original</span><span class="p">[</span><span class="s2">"note"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"first_part"</span>
            <span class="n">row_original</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span>
            <span class="n">row_original</span><span class="p">[</span><span class="s2">"line_changes"</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
            <span class="n">new_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_original</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">row_new</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">row_new</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span>
            <span class="n">row_new</span><span class="p">[</span><span class="s2">"note"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"latter_part"</span>
            <span class="n">row_new</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">"speaker"</span><span class="p">]</span>
            <span class="n">row_new</span><span class="p">[</span><span class="s2">"line_changes"</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span>
            <span class="n">new_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_new</span><span class="p">)</span>

    <span class="n">new_df</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">new_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_row</span> <span class="k">for</span> <span class="n">new_row</span> <span class="ow">in</span> <span class="n">new_rows</span> <span class="k">if</span> <span class="n">new_row</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()]</span>
    <span class="k">for</span> <span class="n">new_row</span> <span class="ow">in</span> <span class="n">new_rows</span><span class="p">:</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">new_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">new_row</span><span class="p">])],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">fix_line_change</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">text_original</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"text"</span><span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">parse_text</span><span class="p">(</span><span class="n">text_original</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">line_change</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">text_original</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>


<span class="c1"># chairman_regex = f"({"|".join(chairman_ocr_errors})"</span>
<span class="c1"># re.sub(pattern, 'THE CHAIRMAN.', string)</span>


<span class="k">def</span> <span class="nf">detect_mostly_capital_sentence</span><span class="p">(</span><span class="n">sentence</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Is mostly capital: over 60% of the characters are mostly capital and after removing the non-mostly capital words,</span>
<span class="sd">    # the sentence is still longer than 5 characters.</span>
<span class="sd">    """</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">sentence</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">upper_word_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
            <span class="n">capital_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">word</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isupper</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">capital_count</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">:</span>
                <span class="n">upper_word_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">upper_word_count</span> <span class="o">&lt;=</span> <span class="n">length</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">split_text_into_sentences_spacy</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"en_core_web_sm"</span><span class="p">)</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">sentences</span> <span class="o">=</span> <span class="p">[</span><span class="n">sent</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">sent</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">sents</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">sentences</span>


<span class="k">def</span> <span class="nf">split_text_into_sentences_re</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">sentence_endings</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">"(?&lt;!\w\.\w.)(?&lt;![A-Z][a-z]\.)(?&lt;=\.|\?|!)\s"</span><span class="p">)</span>
    <span class="n">sentences</span> <span class="o">=</span> <span class="n">sentence_endings</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="c1"># cleaned_sentences = [re.sub(r'[^a-zA-Z\s]', '', sentence).strip() for sentence in sentences if sentence]</span>
    <span class="k">return</span> <span class="n">sentences</span>


<span class="k">def</span> <span class="nf">detect_section_heading</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sentences</span> <span class="o">=</span> <span class="n">split_text_into_sentences_re</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">sentences</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">detect_mostly_capital_sentence</span><span class="p">(</span><span class="n">sentence</span><span class="p">):</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>


<span class="k">def</span> <span class="nf">is_sentence</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">nlp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This function serves to determine whether the text is a sentence.</span>
<span class="sd">    """</span>

    <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="n">contains_verb</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">pos_</span> <span class="o">==</span> <span class="s2">"VERB"</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">)</span>
    <span class="n">contains_subject</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">dep_</span> <span class="o">==</span> <span class="s2">"nsubj"</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">)</span>
    <span class="n">contains_object</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">dep_</span> <span class="o">==</span> <span class="s2">"dobj"</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">)</span>
    <span class="n">contains_punctuation</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">is_punct</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">)</span>
    <span class="n">contains_proper_noun</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">pos_</span> <span class="o">==</span> <span class="s2">"PROPN"</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">)</span>

    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">contains_verb</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">contains_subject</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">contains_object</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">contains_punctuation</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">contains_proper_noun</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">score</span>


<span class="k">def</span> <span class="nf">deal_with_multiple_matched</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This function serves to deal with multiple matches.</span>
<span class="sd">    """</span>

    <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">"matched"</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="n">matched_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span>
    <span class="n">matched_year</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span>
    <span class="n">matched_state</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span>
    <span class="n">matched_identity</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"matched_identity"</span><span class="p">]</span>
    <span class="n">matched_office</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span>
    <span class="n">matched_method</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span>
    <span class="n">matched_committee</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"matched_committee"</span><span class="p">]</span>

    <span class="n">matched_name</span> <span class="o">=</span> <span class="n">matched_name</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">matched_name</span><span class="p">)</span> <span class="k">else</span> <span class="s2">""</span>
    <span class="n">matched_year</span> <span class="o">=</span> <span class="n">matched_year</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">matched_year</span><span class="p">)</span> <span class="k">else</span> <span class="s2">""</span>
    <span class="n">matched_state</span> <span class="o">=</span> <span class="n">matched_state</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">matched_state</span><span class="p">)</span> <span class="k">else</span> <span class="s2">""</span>
    <span class="n">matched_identity</span> <span class="o">=</span> <span class="n">matched_identity</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">matched_identity</span><span class="p">)</span> <span class="k">else</span> <span class="s2">""</span>
    <span class="n">matched_office</span> <span class="o">=</span> <span class="n">matched_office</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">matched_office</span><span class="p">)</span> <span class="k">else</span> <span class="s2">""</span>
    <span class="n">matched_method</span> <span class="o">=</span> <span class="n">matched_method</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">matched_method</span><span class="p">)</span> <span class="k">else</span> <span class="s2">""</span>
    <span class="n">matched_committee</span> <span class="o">=</span> <span class="n">matched_committee</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">matched_committee</span><span class="p">)</span> <span class="k">else</span> <span class="s2">""</span>

    <span class="k">if</span> <span class="n">number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">"no_match"</span> <span class="ow">in</span> <span class="n">matched_name</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"matched"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">row</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">row</span>

    <span class="k">if</span> <span class="n">matched_name</span> <span class="o">==</span> <span class="s2">""</span> <span class="ow">or</span> <span class="n">matched_year</span> <span class="o">==</span> <span class="s2">""</span> <span class="ow">or</span> <span class="n">matched_name</span> <span class="o">==</span> <span class="s2">"no_match"</span><span class="p">:</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_identity"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_identity"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_committee"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="c1"># remaining situation: number &gt;= 2</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">matched_state</span><span class="p">):</span>
        <span class="n">matched_state</span> <span class="o">=</span> <span class="s2">"notapplicable &amp; "</span> <span class="o">*</span> <span class="n">number</span>
        <span class="n">matched_state</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">" &amp; $"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">matched_state</span><span class="p">)</span>

    <span class="n">names</span> <span class="o">=</span> <span class="n">matched_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" &amp; "</span><span class="p">)</span>
    <span class="n">years</span> <span class="o">=</span> <span class="n">matched_year</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" &amp; "</span><span class="p">)</span>
    <span class="n">states</span> <span class="o">=</span> <span class="n">matched_state</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" &amp; "</span><span class="p">)</span>
    <span class="n">identities</span> <span class="o">=</span> <span class="n">matched_identity</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" &amp; "</span><span class="p">)</span>
    <span class="n">offices</span> <span class="o">=</span> <span class="n">matched_office</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" &amp; "</span><span class="p">)</span>
    <span class="n">methods</span> <span class="o">=</span> <span class="n">matched_method</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" &amp; "</span><span class="p">)</span>
    <span class="n">committees</span> <span class="o">=</span> <span class="n">matched_committee</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" &amp; "</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span> <span class="o">!=</span> <span class="n">number</span><span class="p">:</span>
        <span class="n">matched_state</span> <span class="o">=</span> <span class="s2">"notapplicable &amp; "</span> <span class="o">*</span> <span class="n">number</span>
        <span class="n">matched_state</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">" &amp; $"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">matched_state</span><span class="p">)</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">matched_state</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" &amp; "</span><span class="p">)</span>

    <span class="c1"># connections can only sort out no_match</span>
    <span class="n">connections</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">years</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">identities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">offices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">methods</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">committees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="n">connections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">connections</span><span class="p">))</span>

    <span class="n">connections</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">connections</span> <span class="k">if</span> <span class="s2">"no_match"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">connections</span><span class="p">)</span>

    <span class="n">row</span><span class="p">[</span><span class="s2">"matched"</span><span class="p">]</span> <span class="o">=</span> <span class="n">length</span>

    <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_identity"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_identity"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_committee"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"no_match"</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># multiple matches filtering "no_match" to only one</span>
        <span class="n">single_connection</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" | "</span><span class="p">)</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_connection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_connection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_connection</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_identity"</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_connection</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_connection</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_connection</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_committee"</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_connection</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="k">if</span> <span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># deal with same person, different year or committee situation, depends only on name, state, office</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>
        <span class="n">states</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">states</span><span class="p">))</span>
        <span class="n">offices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">offices</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">offices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"matched"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_identity"</span><span class="p">]</span> <span class="o">=</span> <span class="n">identities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="n">offices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="n">methods</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">"matched_committee"</span><span class="p">]</span> <span class="o">=</span> <span class="n">committees</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">row</span>

        <span class="c1"># deal with same person but recorded with nicknames situation</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">offices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">last_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
            <span class="n">last_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">last_names</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">"matched"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">"matched_identity"</span><span class="p">]</span> <span class="o">=</span> <span class="n">identities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="n">offices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="n">methods</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">"matched_committee"</span><span class="p">]</span> <span class="o">=</span> <span class="n">committees</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">row</span>

        <span class="c1"># remaining situations: split up connections again to reorganize the row</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">years</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">states</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">identities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">offices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">committees</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">connection</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">identity</span><span class="p">,</span> <span class="n">office</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">committee</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                <span class="s2">" | "</span>
            <span class="p">)</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">years</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="n">identities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span>
            <span class="n">offices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">office</span><span class="p">)</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
            <span class="n">committees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">committee</span><span class="p">)</span>

        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_name"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">" &amp; "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_year"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">" &amp; "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">years</span><span class="p">)</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_state"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">" &amp; "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_identity"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">" &amp; "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">identities</span><span class="p">)</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_office"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">" &amp; "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">offices</span><span class="p">)</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_method"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">" &amp; "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">methods</span><span class="p">)</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">"matched_committee"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">" &amp; "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">committees</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">row</span>

    <span class="k">return</span> <span class="n">row</span>


<span class="k">def</span> <span class="nf">delete_undeleted_names</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This function serves to delete the undeleted names.</span>
<span class="sd">    """</span>
    <span class="n">speaker_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">"(mr\.|mrs\.|ms\.|miss|senator|representative|chairman|vice|dr\.)\s([^\s]+)"</span><span class="p">,</span>
        <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">"speaker"</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">"chair"</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">previous_text</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="n">current_text</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">]</span>
            <span class="n">current_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">"^\s*"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">current_text</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>

            <span class="c1"># Extract last word from previous_text and first word from current_text</span>
            <span class="n">previous_last_word</span> <span class="o">=</span> <span class="n">previous_text</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">previous_text</span> <span class="k">else</span> <span class="s2">""</span>
            <span class="n">current_first_word</span> <span class="o">=</span> <span class="n">current_text</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">current_text</span> <span class="k">else</span> <span class="s2">""</span>

            <span class="c1"># Calculate fuzzy matching scores</span>
            <span class="n">previous_score</span> <span class="o">=</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">previous_last_word</span><span class="p">,</span> <span class="s2">"THE"</span><span class="p">)</span>
            <span class="n">first_scores</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">current_first_word</span><span class="p">,</span> <span class="s2">"CHAIRMAN"</span><span class="p">),</span>
                <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">current_first_word</span><span class="p">,</span> <span class="s2">"CHAIRWOMAN"</span><span class="p">),</span>
                <span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">(</span><span class="n">current_first_word</span><span class="p">,</span> <span class="s2">"CHAIR"</span><span class="p">),</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="n">previous_score</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
                <span class="n">previous_text</span> <span class="o">=</span> <span class="n">previous_text</span><span class="p">[:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">previous_last_word</span><span class="p">)]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">score</span> <span class="o">&gt;</span> <span class="mi">70</span> <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">first_scores</span><span class="p">):</span>
                <span class="n">current_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">current_first_word</span><span class="p">),</span> <span class="s2">""</span><span class="p">,</span> <span class="n">current_text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
                <span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>

            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_text</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_text</span>

        <span class="c1"># Check if the 'note' column is 'latter_part'</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">"note"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"latter_part"</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">speaker_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Remove prefix from the end of the previous row's 'text' column</span>
                <span class="n">previous_text</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">previous_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_text</span><span class="p">[:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

                <span class="c1"># Remove candidate from the start of the current row's 'text' column</span>
                <span class="n">current_text</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">]</span>
                <span class="n">candidate_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s2">"^\s*"</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">candidate</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
                <span class="p">)</span>
                <span class="n">current_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">candidate_pattern</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">current_text</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_text</span>

    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">spell_check</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">spell</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    This function serves to spell check the text.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">"[^a-zA-Z\s\']"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">unknown_words</span> <span class="o">=</span> <span class="n">spell</span><span class="o">.</span><span class="n">unknown</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
    <span class="n">total_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>

    <span class="n">short_word_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">word</span> <span class="o">!=</span> <span class="s2">"i"</span><span class="p">:</span>
            <span class="n">short_word_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown_words</span><span class="p">),</span> <span class="n">total_count</span><span class="p">,</span> <span class="n">short_word_count</span>
</code></pre></div></div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">November 2, 2024</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">November 2, 2024</span>
  </span>

    
    
    
  </aside>



  



                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 Fred Houze Li
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/fredhli" target="_blank" rel="noopener" title="GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.linkedin.com/in/fredhli/" target="_blank" rel="noopener" title="LinkedIn" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:<fredhli@outlook.com>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l217.6 163.2c11.4 8.5 27 8.5 38.4 0l217.6-163.2c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48zM0 176v208c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V176L294.4 339.2a63.9 63.9 0 0 1-76.8 0z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "navigation.footer", "navigation.tabs", "navigation.tabs.sticky", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.process"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../../main.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
      
    
  </body>
</html>